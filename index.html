<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
</head>
<body>

<canvas id="app"></canvas>

<script type="text/javascript" src="tmlib.js"></script>
<script type="text/javascript" src="bulletml.js"></script>
<script type="text/javascript" srC="tmlib.bulletml.js"></script>

<script>
tm.main(function() {
    app = tm.display.CanvasApp("#app");
    app.fps = 60;
    app.resize(640, 640).fitWindow();
    app.replaceScene(MainScene());
    app.run();
});

tm.define("MainScene", {
    superClass: "tm.app.Scene",

    init: function() {
        this.superInit();
        this.fromJSON({
            children: {
                enemy: {
                    type: "tm.display.CircleShape",
                    init: [50, 50],
                    x: 640 * 0.5, y: 640 * 0.1
                },
                player: {
                    type: "Player",
                    x: 640 * 0.5, y: 640 * 0.9
                }
            }
        });

        var params = {
            target: this.player,
            createNewBullet: function(runner) {
                Bullet(runner).addChildTo(this);
            }.bind(this)
        };


        bulletml.dsl();
        var DANMAKU0 = new bulletml.Root({
            top: action([
                repeat(100, [
                    fire(direction(23, "sequence"), bullet()),
                    wait(1)
                ])
            ])
        });
        var DANMAKU1 = new bulletml.Root({
            top: action([
                repeat(100, [
                    fire(direction(23, "sequence"), bulletRef("straight")),
                    wait(1)
                ])
            ]),
            straight: bullet(action([
                wait("20 + $rand * 50"),
                changeDirection(direction(180, "absolute"), 10)
            ]))
        });

        this.enemy.startDanmaku(DANMAKU1, params);
    },

    gameover: function() {
        var resultScene = tm.scene.ResultScene({
            score: 0,
            width: 640,
            height: 640,
            autopop: false,
        });
        resultScene.on("finish", function() {
            window.location.reload();
        });
        this.app.pushScene(resultScene);
    }
});

tm.define("Bullet", {
    superClass: "tm.bulletml.Bullet",

    init: function(runner) {
        this.superInit(runner);

        this.removeChildren();

        var grad = tm.graphics.RadialGradient(10, 10, 0, 10, 10, 10)
            .addColorStopList([
                { offset: 0.0, color: "hsla(0, 100%, 100%, 1.0)" },
                { offset: 0.5, color: "hsla(0, 100%, 100%, 1.0)" },
                { offset: 1.0, color: "hsla(0, 100%,  50%, 0.0)" },
            ])
            .toStyle();

        this.fromJSON({
            children: {
                body: {
                    type: "tm.display.CircleShape",
                    init: [20, 20, {
                        fillStyle: grad,
                        strokeStyle: "transparent",
                    }],
                },
            },
        });

        this.boundingType = "circle";
        this.radius = 5;
    },

    onenterframe: function() {
        if (this.isHitElement(Player.SINGLETON)) {
            Player.SINGLETON.damage();
            this.remove();
            return;
        }

        if (this.x < 0 || 640 <= this.x || this.y < 0 || 640 <= this.y) {
            this.remove();
            return;
        }
    }
});

tm.define("Player", {
    superClass: "tm.display.TriangleShape",

    init: function() {
        this.superInit(25, 25);
        this.boundingType = "circle";
        this.radius = 1;
        Player.SINGLETON = this;

        this.muteki = 0;
        this.zanki = 3;
    },

    update: function(app) {
        var kb = app.keyboard;
        this.position.add(kb.getKeyDirection().mul(4));

        if (this.x < 0) this.x = 0;
        else if (640 <= this.x) this.x = 640 - 1;
        if (this.y < 0) this.y = 0;
        else if (640 <= this.y) this.y = 640 - 1;

        this.muteki -= 1;
        if (this.muteki > 0) {
            this.alpha = 0.5 + (app.frame % 2) * 0.5;
        } else {
            this.alpha = 1.0;
        }
    },

    damage: function() {
        if (this.muteki <= 0) {
            this.zanki -= 1;
            if (this.zanki === 0) {
                this.getRoot().gameover();
                return;
            }

            this.muteki = 60;
        }
    }
});
Player.SINGLETON = null;
</script>

</body>
</html>
